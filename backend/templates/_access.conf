{% if access_list_id > 0 %}
    # IP Based Authorization - {{access_list.client | size}} rules
    {% if access_list.satisfy_any == 1 %}
    # Satisfy Any
        {% if access_list.items.length > 0 %}
    if ( $access_list_{{ access_list_id }} = 0) {
        set $auth_basic "Authorization required";
    }
    if ( $access_list_{{ access_list_id }} = 1) {
        set $auth_basic off;
    }

    # Authorization
    auth_basic            $auth_basic;
    auth_basic_user_file  /data/access/{{ access_list_id }};

            {% if access_list.pass_auth == 0 %}
    proxy_set_header Authorization "";
            {% endif %}
        {% else %}
    if ( $access_list_{{ access_list_id }} = 0) {
        return {% if drop_unauthorized == 1 %}444{% else %}403{% endif %};
    }
        {% endif %}
    {% else %}
    # Satisfy All
        {% if access_list.items.length > 0 %}
    if ( $access_list_{{ access_list_id }} = 1) {
        set $auth_basic "Authorization required";
    }
    if ( $access_list_{{ access_list_id }} = 0) {
        return {% if drop_unauthorized == 1 %}444{% else %}403{% endif %};
    }

    # Authorization
    auth_basic            $auth_basic;
    auth_basic_user_file  /data/access/{{ access_list_id }};

            {% if access_list.pass_auth == 0 %}
    proxy_set_header Authorization "";
            {% endif %}
        {% else %}
    if ( $access_list_{{ access_list_id }} = 0) {
        return {% if drop_unauthorized == 1 %}444{% else %}403{% endif %};
    }
        {% endif %}
    {% endif %}

    {% if access_list.clientcas.size > 0 %}
    # TLS Client Certificate Authorization
    if ($ssl_client_verify != "SUCCESS") {
        return {% if drop_unauthorized == 1 %}444{% else %}403{% endif %};
    }
    {% endif %}
{% endif %}
